## 1.修改软件安装源
```
1.cd /etc/yum.repos.d/
2.rm CentOS-* -f
3.wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo
4.yum clean all
5.yum makecache
```
## 2.创建系统初始必要目录
```
mkdir -p /xx-java/data
mkdir -p /xx-java/script
mkdir -p /xx-java/config
mkdir -p /xx-java/yt_logs
```
## 3.安装mysqld服务
```
unzip bushu.zip
tar -xvf mysql-8.0.24-1.el8.x86_64.rpm-bundle.tar
rpm -ivh  mysql-community-common-8.0.24-1.el8.x86_64.rpm --force --nodeps
rpm -ivh  mysql-community-libs-8.0.24-1.el8.x86_64.rpm --force --nodeps
rpm -ivh  mysql-community-client-8.0.24-1.el8.x86_64.rpm --force --nodeps
rpm -ivh  mysql-community-server-8.0.24-1.el8.x86_64.rpm --force --nodeps
mysqld --initialize
chown -R mysql:mysql /var/lib/mysql
systemctl start mysqld.service
systemctl enable mysqld.service
systemctl status mysqld.service
(a=`grep -a 'password' /var/log/mysqld.log`; echo ${a#*host: })
mysql -uroot -p
alter user 'root'@'localhost' identified with mysql_native_password by 'abc!@#123';
flush privileges;
use mysql;
update user set host='%' where user ='root';
flush privileges;
exit
```

## 4.配置mysql服务
```
vim /etc/my.cnf
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
expire_logs_days=7
max_binlog_size=500M
max_allowed_packet=536870912
systemctl start mysqld.service
```

##  5.数据库初始化
```
mysql -uroot -p'password' -e"CREATE SCHEMA 数据库名 DEFAULT CHARACTER SET utf8mb4";
mysql -uroot -p
use feg2022_school
source x.sql
```

## 6.添加数据库访问账户
```
CREATE USER `用户名`@`%` IDENTIFIED WITH mysql_native_password BY 'feg_app2020@_学校id';
GRANT Alter, Alter Routine, Create, Create Routine, Create Temporary Tables, Create View, Delete, Drop, Event, Execute, Index, Insert, Lock Tables, References, Select, Show View, Trigger, Update ON `数据库名`.* TO `feg_app`@`%`;
FLUSH PRIVILEGES;
```
-----------------------------------------
## 7.检查防火墙
```
systemctl status firewalld  #查看防火墙状态
systemctl stop firewalld #关闭防火墙
systemctl disable firewalld #禁用防火墙开机启动
或者不关闭防火墙的情况下，可以选择放出你需要的端口
永久开放80端口，nginx使用的80，mysql使用的3306
firewall-cmd --zone=public --add-port=80/tcp --permanent  
#重新初始化防火墙 一般新开端口之后要重新初始化 不然可能新开的端口不生效
firewall-cmd --reload
#查看已经开放的端口列表
firewall-cmd --zone=public --list-ports
firewalld:
#开机启动防火墙
systemctl enable firewalld
#开机禁用防火墙
systemctl disable firewalld
#启动防火墙(临时)
systemctl start firewalld
#关闭防火墙(临时)
systemctl stop firewalld
#永久开放80端口
firewall-cmd --zone=public --add-port=80/tcp --permanent  
#重新初始化防火墙 一般新开端口之后要重新初始化 不然可能新开的端口不生效
firewall-cmd --reload
#查看已经开放的端口列表
firewall-cmd --zone=public --list-ports

iptables：
iptables -I INPUT -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -p tcp --dport 22 -j ACCEPT
iptables -I INPUT -p tcp --dport 10:21 -j ACCEPT
iptables -nL
```
-----------------------------------------

unzip gcc.zip
cd gcc && rpm -ivh *.rpm --nodeps --force
下面的两条命令需要服务器连结外网才能成功执行
yum install gcc-c++ -y
yum install perl -y
进入nginx目录
unzip nginx.zip
pcre安装
执行如下命令：
tar -zxvf pcre-8.44.tar.gz
cd pcre-8.44/
./configure
make && make install
zlib安装
执行如下命令：
tar -zxvf zlib-1.2.11.tar.gz
cd zlib-1.2.11/
./configure
make && make install
openssl安装
执行如下命令：
tar -zxvf openssl-1.1.1g.tar.gz
cd openssl-1.1.1g/
./config
make && make install
-----------------------------------------

安装nginx服务本体
执行如下命令：
tar -zxvf nginx-1.18.0.tar.gz
cd nginx-1.18.0/
./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-pcre=../pcre-8.44 --with-zlib=../zlib-1.2.11 --with-openssl=../openssl-1.1.1g
make && make install
-----------------------------------------

配置nginx配置文件
vi /usr/local/nginx/conf/nginx.conf
添加一下内容
#user  nobody;
worker_processes  1;
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
    client_max_body_size 2048m;
    upstream web-platform{
        server 127.0.0.1:8081;
    }

    upstream service {
        server 127.0.0.1:8080;
    }

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        #   指定允许跨域的方法，*代表所有
        add_header Access-Control-Allow-Methods *;

        #   预检命令的缓存，如果不缓存每次会发送两次请求
        add_header Access-Control-Max-Age 3600;
        #   不带cookie请求，并设置为false
        add_header Access-Control-Allow-Credentials false;

        #   表示允许这个域跨域调用（客户端发送请求的域名和端口） 
        #   $http_origin动态获取请求客户端请求的域   不用*的原因是带cookie的请求不支持*号
        add_header Access-Control-Allow-Origin $http_origin;

        #   表示请求头的字段 动态获取
        add_header Access-Control-Allow-Headers 
        $http_access_control_request_headers;

        #   OPTIONS预检命令，预检命令通过时才发送请求
        #   检查请求的类型是不是预检命令
        if ($request_method = OPTIONS){
                return 200;
        }        
        error_page   500 502 503 504  /50x.html;
        
        location = /50x.html {
            root   html;
        }

        # 静态资源访问 -- 校本
        location /school/ {
            add_header Access-Control-Allow-Crigin *;
            add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
            alias /home/mnt/yatai-java/data/upload/school/;
            allow all;
            autoindex on;
        }

       location /xview {
            proxy_pass http://127.0.0.1:8012/xview;

            proxy_redirect off;
            proxy_set_header Host $host:$server_port;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /platform-api/ {
           proxy_pass http://service/;
           proxy_redirect off;
           proxy_set_header Host $host:$server_port;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 学校管理后台(校本环境)
        location /web-platform {
           proxy_pass http://web-platform;
        }

    }
-----------------------------------------

安装nginx到系统服务
vi /etc/systemd/system/nginx.service
添加以下内容
[Unit]
Description=A high performance web server and a reverse proxy server
After=network.target network-online.target nss-lookup.target

[Service]
Type=forking
ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
ExecStartPost=/bin/sleep 0.1
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
WantedBy=multi-user.target
-----------------------------------------

启动nginx服务并添加开启启动
刚刚是复制nginx.conf少了一个回括号，导致启动失败
systemctl daemon-reload
systemctl start nginx.service
systemctl enable nginx.service
-----------------------------------------

安装docker服务
tar -xvf docker-20.10.18.tgz
cp docker/* /usr/bin/
vi /etc/systemd/system/docker.service
-----------------------------------------

安装docker服务到系统
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s


[Install]
WantedBy=multi-user.target
-----------------------------------------

配置docker仓库镜像
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
    "registry-mirrors" : [
    "http://2ced6w6j.mirror.aliyuncs.com",
    "http://registry.docker-cn.com",
    "http://docker.mirrors.ustc.edu.cn",
    "http://hub-mirror.c.163.com"
    ],
    "insecure-registries" : [
    "registry.docker-cn.com",
    "docker.mirrors.ustc.edu.cn"
    ],
    "hosts": ["tcp://0.0.0.0:2375", "unix:///var/run/docker.sock"]
}
EOF
-----------------------------------------

添加docker启动服务到系统并设置开机启动
systemctl daemon-reload
systemctl start docker.service
systemctl enable docker.service
-----------------------------------------

登录华为容器镜像
docker login -u cn-north-1@XITUMGMWJXRKJG30GPIL -p b38c14b2e0c5b147d588244d5acc557c572de4ef1804f7784467ed18310b3e6e swr.cn-north-1.myhuaweicloud.com
-----------------------------------------

安装redis服务  这个需要从外网拉，所以速度会慢一些
docker run -itd --name redis -p 6379:6379 --restart always -d redis:latest --requirepass "123456"
-----------------------------------------

安装后台服务
mv application.yml  /yatai-java/config
mv application-pro.yml  /yatai-java/config
docker run -itd -p 8080:8080 --name platform -e 'SPRING_PROFILES_ACTIVE=pro' -e 'JAVA_OPTIONS=-Xmx8192m -Xms1024m -Duser.timezone=Asia/Shanghai' -e 'SERVER_PORT=8080' -e 'SERVER_IP=192.168.1.1'  -e 'SCHOOL_ID=0'  -e 'SYSTEM_ENV=school'  -v /home/mnt:/mnt -v /yatai-java/data:/yatai-java/data -v /yatai-java/config:/config -v /yatai-java/yt_logs:/yatai-java/yt_logs --restart=always swr.cn-north-1.myhuaweicloud.com/ytwlrj/yatai-school-platform:latest
-----------------------------------------

安装web服务
docker run -itd --name tomcat  -p 8081:8080 --restart=always swr.cn-north-1.myhuaweicloud.com/ytwlrj/web-school:latest
-----------------------------------------

部署预览服务
docker run -itd -p 8012:8012 --name kkfile -e 'USE_ENV=school' -v /home/mnt:/mnt swr.cn-north-1.myhuaweicloud.com/ytwlrj/keking/kkfileview:latest
-----------------------------------------

部署自动更新服务  这个也需要从外网拉镜像，会慢一些
mv watchtower-starup.sh  /yatai-java/script
chmod +X watchtower-starup.sh
./watchtower-starup.sh
-----------------------------------------

添加断网监听脚本及缓存清理脚本
mv network-monitor.sh  /yatai-java/script
crontab -e
0 23 * * * find /var/lib/docker/containers/ -type f -size +500M -name "*-json.log" -exec truncate -s 0 {} \;
*/1 * * * * nohup /yatai-java/script/network-monitor.sh > /yatai-java/script/network-monitor-nohup.out 2>&1 &

-----------------------------------------
刚刚登陆失败是因为浏览器缓存访问了错误的后台服务接口导致，实际服务已经正常，用无痕模式测试登录没有异常
<!--stackedit_data:
eyJoaXN0b3J5IjpbNzI4MTA1NjY0XX0=
-->